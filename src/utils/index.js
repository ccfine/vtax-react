/**
 * author       : liuliyuan
 * createTime   : 2017/12/5 18:09
 * description  :
 */
import React from 'react';
import request from './request'
import composeMenus from './composeMenus'
import regRules from './regRules'
import getFields from './getFields'
import {BigNumber} from 'bignumber.js'

const fMoney = (s,n=2)=>{
    if(s === "" || s === 0 || typeof (s) === 'undefined'){
        return '0.00';
    }
    n = n > 0 && n <= 20 ? n : 2;
    /**添加一下代码 大数字用parseFloat不精确 */
    s = s.toString().replace(/[^\d\\.-]/g, "");
    return (new BigNumber(s)).toFormat(n);

    // s = parseFloat((s + "").replace(/[^\d\\.-]/g, "")).toFixed(n) + "";
    // /**过滤负号 .replace(/-/g,'') 解决负数转换 2018/3/19*/
    // let l = s.split(".")[0].replace(/-/g,'').split("").reverse(),
    //     r = s.split(".")[1];
    // let t = "";
    // for (let i = 0; i < l.length; i++) {
    //     t += l[i] + ((i + 1) % 3 === 0 && (i + 1) !== l.length ? "," : "");
    // }
    // /**添加负号 (s.indexOf('-')>-1?"-":"") + 解决负数转换 2018/3/19*/
    // return  (s.indexOf('-')>-1?"-":"") + t.split("").reverse().join("") + "." + r;
}
const getUrlParam = function(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
    var r = window.location.search.substr(1).match(reg);  //匹配目标参数
    if (r != null) return decodeURI(r[2]); return null; //返回参数值
}
const getDict = type => {
    return new Promise(function (resolve, reject) {
        request.get(`/sys/dict/listBaseInfo/${type}`)
            .then(({data})=>{
                if(data.code===200){
                    resolve(data.data)
                }else{
                    reject(data.msg)
                }
            })
    })
}
const requestDict = async (type,callback)=>{
    let result = await getDict(type);
    callback(result)
}

/**
 ** 除法函数，用来得到精确的除法结果
 ** 说明：javascript的除法结果会有误差，在两个浮点数相除的时候会比较明显。这个函数返回较为精确的除法结果。
 ** 调用：accDiv(arg1,arg2)
 ** 返回值：arg1除以arg2的精确结果
 **/
const accDiv=(arg1, arg2)=> {
    if(parseInt(arg1, 0) === 0 && parseInt(arg2, 0) === 0) return 0;

    let t1 = 0, t2 = 0, r1, r2;
    try {
        t1 = arg1.toString().split(".")[1].length;
    }
    catch (e) {
    }
    try {
        t2 = arg2.toString().split(".")[1].length;
    }
    catch (e) {
    }

    r1 = Number(arg1.toString().replace(".", ""));
    r2 = Number(arg2.toString().replace(".", ""));
    return (r1 / r2) * Math.pow(10, t2 - t1);

}

/**
 ** 乘法函数，用来得到精确的乘法结果
 ** 说明：javascript的乘法结果会有误差，在两个浮点数相乘的时候会比较明显。这个函数返回较为精确的乘法结果。
 ** 调用：accMul(arg1,arg2)
 ** 返回值：arg1乘以 arg2的精确结果
 **/
const accMul=(arg1, arg2)=> {
    let m = 0, s1 = arg1.toString(), s2 = arg2.toString();
    try {
        m += s1.split(".")[1].length;
    }
    catch (e) {
    }
    try {
        m += s2.split(".")[1].length;
    }
    catch (e) {
    }
    return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
}

/**
 ** 减法函数，用来得到精确的减法结果
 ** 说明：javascript的减法结果会有误差，在两个浮点数相减的时候会比较明显。这个函数返回较为精确的减法结果。
 ** 调用：accSub(arg1,arg2)
 ** 返回值：arg1加上arg2的精确结果
 **/
const accSub=(arg1, arg2)=> {
    let r1, r2, m, n;
    try {
        r1 = arg1.toString().split(".")[1].length;
    }
    catch (e) {
        r1 = 0;
    }
    try {
        r2 = arg2.toString().split(".")[1].length;
    }
    catch (e) {
        r2 = 0;
    }
    m = Math.pow(10, Math.max(r1, r2)); //last modify by deeka //动态控制精度长度
    n = (r1 >= r2) ? r1 : r2;
    return ((arg1 * m - arg2 * m) / m).toFixed(n);
};

/**
 ** 加法函数，用来得到精确的加法结果
 ** 说明：javascript的加法结果会有误差，在两个浮点数相加的时候会比较明显。这个函数返回较为精确的加法结果。
 ** 调用：accAdd(arg1,arg2)
 ** 返回值：arg1加上arg2的精确结果
 **/
const accAdd=(arg1, arg2)=>{
    let r1, r2, m, c;
    try {
        r1 = arg1.toString().split(".")[1].length;
    }
    catch (e) {
        r1 = 0;
    }
    try {
        r2 = arg2.toString().split(".")[1].length;
    }
    catch (e) {
        r2 = 0;
    }
    c = Math.abs(r1 - r2);
    m = Math.pow(10, Math.max(r1, r2));
    if (c > 0) {
        let cm = Math.pow(10, c);
        if (r1 > r2) {
            arg1 = Number(arg1.toString().replace(".", ""));
            arg2 = Number(arg2.toString().replace(".", "")) * cm;
        } else {
            arg1 = Number(arg1.toString().replace(".", "")) * cm;
            arg2 = Number(arg2.toString().replace(".", ""));
        }
    } else {
        arg1 = Number(arg1.toString().replace(".", ""));
        arg2 = Number(arg2.toString().replace(".", ""));
    }
    return (arg1 + arg2) / m;
};

//获取html
const htmlDecode = html =>{
    if(html){
        let div = document.createElement( 'div' );
        div.innerHTML = html;
        return div.textContent;
    }
};

//将0.5转换成50%
const toPercent = val=>{
    let valNum = Number(val);
    if(isNaN(valNum) || valNum === 0)return val;
    return `${valNum*100}%`;
}

//将50%转换成0.5
const fromPercent = val=>{
    let valTrim = val.replace?val.replace('%',''):val;
    let valNum = Number(valTrim);
    if(isNaN(valNum))return val;
    return valNum/100;
}

// 提交、撤回相关 状态显示
const transformDataStatus = status =>{
    status = parseInt(status,0)
    if(status===1){
        return '暂存';
    }
    if(status===2){
        return '提交'
    }
    return status
}
const listMainResultStatus = (statusParam) =>{
    return (statusParam && statusParam.status) && <div style={{marginRight: 30, display: 'inline-block'}}>
                                <span style={{marginRight: 20}}>状态：<label style={{color: '#f5222d'}}>{
                                    transformDataStatus(statusParam.status)
                                }</label></span>
        {
            statusParam.lastModifiedDate && <span>提交时间：{statusParam.lastModifiedDate}</span>
        }
    </div>
}

export {
    regRules,
    request,
    fMoney,
    getUrlParam,
    composeMenus,
    requestDict,
    accDiv,
    accMul,
    accSub,
    accAdd,
    getFields,
    htmlDecode,
    toPercent,
    fromPercent,
    listMainResultStatus,
}